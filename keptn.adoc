

== Keptn - event-based control plane for continuous delivery and automated operations for cloud-native applications
----
mkdir keptn
oc new-project keptn
oc project keptn
curl -sL https://get.keptn.sh | sudo -E bash
----


----
oc adm policy add-cluster-role-to-user cluster-admin  system:serviceaccount:keptn:default
oc adm policy add-cluster-role-to-user cluster-admin  system:serviceaccount:keptn-configuration-service
oc adm policy add-cluster-role-to-user cluster-admin  system:serviceaccount:keptn:builder                       
oc adm policy add-cluster-role-to-user cluster-admin  system:serviceaccount:keptn:keptn-default                       
oc adm policy add-cluster-role-to-user cluster-admin  system:serviceaccount:keptn:deployer                      
oc adm policy add-cluster-role-to-user cluster-admin  system:serviceaccount:keptn:keptn-api-service            
oc adm policy add-cluster-role-to-user cluster-admin  system:serviceaccount:keptn:keptn-helm-service            
oc adm policy add-cluster-role-to-user cluster-admin  system:serviceaccount:keptn:keptn-lighthouse-service
----

----
keptn install --platform=openshift
keptn creates the folder /root/.keptn/ to store logs and possibly creds.
Helm Chart used for Keptn installation: https://storage.googleapis.com/keptn-installer/keptn-0.7.0.tgz
Installing Keptn ...
Please enter the following information or press enter to keep the old value:
Openshift Server URL []: https://api.ocp4.local:6443
....
Using a file-based storage for the key because the password-store seems to be not set up.
Existing Keptn installation found in namespace keptn

Do you want to overwrite this installation? (y/n)
y
Start upgrading Helm Chart keptn in namespace: keptn
----



See https://tutorials.keptn.sh/tutorials/keptn-installation-openshift-07/index.html?index=..%2F..index#5


----
kubectl -n keptn port-forward service/api-gateway-nginx 8080:80 &
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
Handling connection for 8080
----

----
Keep the above window running and go back to your initial terminal window 
----

----
KEPTN_ENDPOINT=http://localhost:8080/api
KEPTN_API_TOKEN=$(kubectl get secret keptn-api-token -n keptn -ojsonpath={.data.keptn-api-token} | base64 --decode)
keptn auth --endpoint=$KEPTN_ENDPOINT --api-token=$KEPTN_API_TOKEN
Starting to authenticate
Successfully authenticated
Using a file-based storage for the key because the password-store seems to be not set up.
----


----
Write down the values returned by:
keptn configure bridge --output
----

----
user: keptn
password: <password>
----

----
Ensure that the terminal window with 
kubectl -n keptn port-forward service/api-gateway-nginx 8080:80
is still running, then

Browse to localhost:8080
----


----
DT_TENANT=eye15053.live.dynatrace.com
DT_API_TOKEN=<Dynatrace API token>
DT_PAAS_TOKEN=<Dynatrace PaaS token>
oc -n keptn create secret generic dynatrace --from-literal="DT_TENANT=$DT_TENANT" --from-literal="DT_API_TOKEN=$DT_API_TOKEN"  --from-literal="DT_PAAS_TOKEN=$DT_PAAS_TOKEN" --from-literal="KEPTN_API_URL=http://localhost:8080/api" --from-literal="KEPTN_API_TOKEN=$KEPTN_API_TOKEN" 
----



----
oc apply -f https://raw.githubusercontent.com/keptn-contrib/dynatrace-service/release-0.7.0/deploy/manifests/dynatrace-service/dynatrace-service.yaml
----


----
oc project
Using project "keptn" on server "https://api.ocp4.local:6443".
oc get pods
NAME                                            READY   STATUS    RESTARTS   AGE
api-gateway-nginx-5b865b66b8-9x988              1/1     Running   0          19m
api-service-6d86cb4f88-fqgvp                    1/1     Running   0          19m
bridge-6594f6b8c-hn4gm                          1/1     Running   0          19m
dynatrace-service-55dc8cf558-vfx79              1/1     Running   1          9s
dynatrace-service-distributor-f59bd95fb-hl2rz   1/1     Running   0          9s
eventbroker-go-5674d9646d-88tv5                 1/1     Running   0          19m
helm-service-85f8bf5fd6-wjlvn                   2/2     Running   2          19m
keptn-nats-cluster-0                            3/3     Running   0          19m
lighthouse-service-6d4b5dcd9-r5mrs              2/2     Running   2          19m
mongodb-datastore-647b5bc584-x88tg              2/2     Running   2          19m
remediation-service-cf4b7b97f-qlq5q             2/2     Running   2          19m
shipyard-service-5c98f89f4c-znscx               2/2     Running   2          19m
----

----
keptn configure monitoring dynatrace
----


image:images/nexus20.png[title="console"]



----
cat ./shipyard.yaml
stages:
  - name: "dev"
    deployment_strategy: "direct"
    test_strategy: "functional"
  - name: "staging"
    approval_strategy:
      pass: "automatic"
      warning: "manual"
    deployment_strategy: "blue_green_service"
    test_strategy: "performance"
  - name: "production"
    approval_strategy:
      pass: "manual"
      warning: "manual"
    deployment_strategy: "blue_green_service"
    remediation_strategy: "automated
----


----
keptn create project marc2 --shipyard=./shipyard.yaml
----


----
oc logs dynatrace-service-6f7848749-wfgw4 --follow

{"timestamp":"2020-07-26T02:41:07.020914691Z","logLevel":"DEBUG","message":"Dynatrace service returned status 200 OK"}
{"timestamp":"2020-07-26T02:41:07.021217513Z","logLevel":"INFO","message":"Creating Dashboard for project marc2"}
{"timestamp":"2020-07-26T02:41:07.296897299Z","logLevel":"DEBUG","message":"Dynatrace service returned status 201 Created"}
{"timestamp":"2020-07-26T02:41:07.29707368Z","logLevel":"INFO","message":"Dynatrace dashboard created successfully. You can view it here: https://eye15053.live.dynatrace.com/#dashboards"}
{"timestamp":"2020-07-26T02:41:07.385872921Z","logLevel":"DEBUG","message":"Dynatrace service returned status 200 OK"}
{"timestamp":"2020-07-26T02:41:07.493885101Z","logLevel":"DEBUG","message":"Dynatrace service returned status 201 Created"}
{"timestamp":"2020-07-26T02:41:07.604932139Z","logLevel":"DEBUG","message":"Dynatrace service returned status 201 Created"}
{"timestamp":"2020-07-26T02:41:07.719819202Z","logLevel":"DEBUG","message":"Dynatrace service returned status 201 Created"}
{"timestamp":"2020-07-26T02:41:07.814504617Z","logLevel":"DEBUG","message":"Dynatrace service returned status 201 Created"}
----



----
keptn create project sockshop111 --shipyard=./shipyard.yaml --git-token=<gitlab token> --git-user=<gitlab user>  --git-remote-url=https://gitlab.com/marcredhat/dynatrace-pipeline
Starting to create project
Handling connection for 8080
ID of Keptn context: 133ff368-ba8d-48fc-958d-734583bf2fa2
Handling connection for 8080
Project sockshop111 created
Stage test created
Shipyard successfully processed
----

----
git clone https://github.com/keptn/examples.git
cd examples/onboarding-carts
keptn onboard service carts --project=sockshop111 --chart=./carts
Starting to onboard service
Handling connection for 8080
ID of Keptn context: 79df125e-dac7-4e5e-ad43-522cf887f80c
Handling connection for 8080
Create umbrella Helm Chart for project sockshop111
Creating new Keptn service carts in stage test
Finished creating service carts in project sockshop111
----

----
https://keptn.sh/docs/0.6.0/usecases/onboard-carts-service/
----



----

 keptn add-resource --project=sockshop111 --service=carts --stage=test --resource=jmeter/basiccheck.jmx --resourceUri=jmeter/basiccheck.jmx
 Adding resource jmeter/basiccheck.jmx to service carts in stage test in project sockshop111
 Handling connection for 8080
 Resource has been uploaded.


 keptn add-resource --project=sockshop111 --service=carts --stage=test  --resource=jmeter/load.jmx --resourceUri=jmeter/load.jmx
 Adding resource jmeter/load.jmx to service carts in stage test in project sockshop111
 Handling connection for 8080
 Resource has been uploaded.
----

----
keptn onboard service carts --project=sockshop111 --chart=./carts
Starting to onboard service
Handling connection for 8080
ID of Keptn context: 8d832271-ab33-4e49-bc0b-8542c32b0d43
Handling connection for 8080
Creating new Keptn service carts in stage test
Service already exists
----

----
keptn onboard service carts-db --project=sockshop111  --chart=./carts-db --deployment-strategy=direct
Starting to onboard service
Handling connection for 8080
ID of Keptn context: 3878f8c0-b6bb-47a4-b952-59109e8a186c
Handling connection for 8080
Creating new Keptn service carts-db in stage test
Finished creating service carts-db in project sockshop111


keptn send event new-artifact --project=sockshop111 --service=carts-db --image=docker.io/mongo --tag=4.2.2
----

----
oc logs lighthouse-service-6d4b5dcd9-s9h6t -c distributor

Received a message for topic [sh.keptn.internal.event.service.create]: {"contenttype":"application/json","data":{"project":"sockshop111","service":"carts-db","helmChart":"H4sIFAAAAAAA/ykAK2FIUjBjSE02THk5NWIzVjBkUzVpWlM5Nk9WVjZNV2xqYW5keVRRbz1IZWxtAOxXT2/6RhDl7E8x4tQeDDYQkHz7KT20avMrSqX0WA3rCXGz3t3ujmlRynev1mBjHDCHpEkr+V2snf0zM/a8N2uBll2Yrsa3T2h5tMVcDt4bURRF89msfEZR1H5G8XQ2iKeLOI7ni9lkPojiyXwxH0D07pGcQeEY7SB6s692cv8ToMkeyLpMqwQ2cZCSEzYzXI6/wPckcxC+MuBRW3BkN5kgqIomUJhTchxuqpOiUTyKgs/Orcd11PzfoCzI/SsCcJX/s2mL/1MvCT3/PwBZjmtKINdqrQNLRmYCb3WhOIE4OPA9CQDoLyarUC615QQmiyheBACZOmdtqcJnp9ijAzX/mXIjkcmNK1OYkpF6m5N6473gCv8ns3m7/y9uJlHP/49AGIZB6w7wnKk0gaW3OCbFD1oWOd1KzPIgJ8YUGZNXNA9LCfFzgTMk/AIUgpy70yk5PwzhnjD91WZMPytBAYAlpwsr9tN++EdBjg8jAMfaluoUR9FdFjhGLlwCL7ugHTUa48Z16N/VddsRbwAgcUXy4A2NacxVGRwE0Tt9gdHDvkU2VRJ2u8AHapFpvd0fxVtDCdyTsITs03QkSbC2++kcWTz91HDddg5QcfGwoZGDhzzZ+3r3HkfynplEY0bPxYqsIiY3yvR4/3IaWT6TYTWqbnxlmpf2ZsoxKkEJDDsOCF/NHUOE3W7Y4UDo3GhVpuJfxAoddaw2aDnUj+eiMVb/TuKauxwVrikNV9sEfvT7OtbWV96XF/jGGZkxDJNh7bZsr9+Ofovhb0jpEQvJMCxlloew20GN0kVVdh5CK8ZMka2/dNiqYKjDOjTxRrqlpfnVSsOykHKpZSa2Cfzw+FXz0pLzNKlWGW25UVnhMYrTDr/Hkb6ek5V1U8rFnWfHyVG5tyyRnxIY+684btRjh5jUrhgtV8F/kX/i1gVNhxdf06uzAMw5bUsa0Qhv+HrpmM/W7PdEV/8/cPfN/wTX7v/Tm5tW/58vFjd9//8IXOz/v+w/flcHreSqVo2Keg0hqmrIT1R6ZEotObOo+ZNRLWa0a+LlpS3NP5BDMz7ptifN8bNfdo8ePXr8h/BPAAAA///heHaOABgAAA==","deploymentStrategies":{"*":"direct"},"eventContext":{"keptnContext":"3878f8c0-b6bb-47a4-b952-59109e8a186c","token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjczNjAwMjF9.RTItxs4nNzc-ZT1z33Cht0mxnUb5oR5Rxze1iL05SJg"}},"id":"edac1ad8-60db-408b-ae74-5c32e7b4778e","shkeptncontext":"3878f8c0-b6bb-47a4-b952-59109e8a186c","source":"https://github.com/keptn/keptn/api","specversion":"0.2","time":"2020-08-01T04:27:01.919032794Z","type":"sh.keptn.internal.event.service.create"}
Received a message for topic [sh.keptn.event.configuration.change]: {"contenttype":"application/json","data":{"canary":{"action":"set","value":100},"eventContext":{"keptnContext":"a1756959-bf11-40da-9898-63b53b82760a","token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjczNjAwODZ9.K3Ta6bV9lgWZExuTLwt53g-znG-bBUgWEy-D6_dsWzs"},"labels":null,"project":"sockshop111","service":"carts-db","stage":"","valuesCanary":{"image":"docker.io/mongo:4.2.2"}},"id":"d8057145-95a6-4191-8849-7e989d7bf050","shkeptncontext":"a1756959-bf11-40da-9898-63b53b82760a","source":"https://github.com/keptn/keptn/cli#configuration-change","specversion":"0.2","time":"2020-08-01T04:28:06.916753285Z","type":"sh.keptn.event.configuration.change"}
----

----
https://tutorials.keptn.sh/tutorials/keptn-quality-gates-dynatrace/index.html?index=..%2F..index#7
----

----
git clone --branch release-0.6.2 https://github.com/keptn/examples.git --single-branch
----

----
keptn create project sockshopgate --shipyard=./shipyard-quality-gates.yaml --git-token=<gitlab token>  --git-user=<gitlab user>  --git-remote-url=https://gitlab.com/marcredhat/dynatrace-pipeline
Starting to create project
Handling connection for 8080
ID of Keptn context: 2f0e7f63-4472-4270-aedf-e1e3b5d79e8e
Handling connection for 8080
Project sockshopgate created
Stage hardening created
Shipyard successfully processed
----
image:images/nexus21.png[title="console"]

